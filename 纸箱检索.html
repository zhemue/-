<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çº¸ç®±å°ºå¯¸æ£€ç´¢</title>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        .erp-blue { background-color: #1890ff; }
        .resizer { position: absolute; right: 0; top: 0; width: 4px; height: 100%; cursor: col-resize; }
        .resizer:hover { background: #1890ff; }
        th { position: relative; white-space: nowrap; background: #fafafa; border: 1px solid #e8e8e8; font-size: 14px; }
        td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid #e8e8e8; padding: 8px 10px; font-size: 14px; }
        .history-item:hover { background: #f0f7ff; cursor: pointer; }
        .active-tab { border-bottom: 2px solid white; font-weight: bold; }
        .stat-badge { 
            color: rgb(0, 0, 0);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .search-mode-select {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 14px;
            background: white;
            outline: none;
            cursor: pointer;
        }
        .diff-positive { color: #ff4d4f; font-weight: bold; font-size: 20px; }
        .diff-negative { color: #52c41a; font-weight: bold; font-size: 20px; }
        .diff-zero { color: #187cff; font-weight: bold; font-size: 20px; }
        .diff-label {
            font-size: 20px;
            color: #000000;
            margin-right: 4px;
        }
        .tolerance-input {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 4px 12px;
            width: 60px;
            font-size: 16px;
            background: white;
            outline: none;
        }
        .tolerance-label {
            font-size: 16px;
            color: #666;
            margin-right: 4px;
        }
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        .page-btn {
            padding: 5px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .page-btn:hover:not(:disabled) {
            background: #f0f0f0;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-input {
            width: 55px;
            text-align: center;
            padding: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        .page-size-select {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 5px;
            font-size: 14px;
            background: white;
            outline: none;
        }
        .page-info {
            color: #666;
            font-size: 14px;
        }
        .current-page {
            font-weight: bold;
            color: #1890ff;
        }
        /* åŠ è½½æç¤º */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-spinner {
            width: 35px;
            height: 35px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* æ¯é¡µæ˜¾ç¤ºæ¡æ•°é€‰æ‹©å™¨ */
        .page-size-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .page-size-label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col font-sans text-base">
    <div id="app" class="flex flex-col h-full">
        <header class="erp-blue px-4 py-3 flex items-center justify-between text-white shadow-md z-20">
            <div class="flex items-center gap-6">
                <span class="font-bold text-xl tracking-wider">ğŸ“¦ çº¸ç®±å°ºå¯¸æ£€ç´¢ç³»ç»Ÿ</span>
                <nav class="flex gap-6 text-base">
                    <button @click="switchToSearch" :class="{'active-tab': viewMode === 'search'}" class="py-1 px-2">å°ºå¯¸æ£€ç´¢</button>
                    <button @click="switchToAll" :class="{'active-tab': viewMode === 'all'}" class="py-1 px-2">è´§å“æ¡£æ¡ˆ</button>
                    <button @click="viewMode = 'stats'" :class="{'active-tab': viewMode === 'stats'}" class="py-1 px-2">æœç´¢ç»Ÿè®¡</button>
                </nav>
            </div>
            <div class="flex items-center gap-3">
                <!-- è¿™é‡Œä¸å†æ˜¾ç¤ºå¯¼å…¥ç›¸å…³æŒ‰é’® -->
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-52 bg-white border-r flex flex-col shadow-inner">
                <div class="p-4 border-b bg-gray-50 text-sm font-bold text-gray-500 flex justify-between">
                    <span>æœç´¢å†å²</span>
                    <button @click="clearHistory" class="text-blue-400 font-normal hover:underline text-sm">æ¸…ç©º</button>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div v-for="(h, idx) in history" :key="idx" @click="applyHistory(h)" class="p-4 border-b history-item group">
                        <div class="flex justify-between items-center">
                            <div class="text-blue-600 font-mono font-bold text-base">{{h.l}}Ã—{{h.w}}Ã—{{h.h}}</div>
                            <span class="stat-badge">{{h.count || 1}}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 italic">{{h.time}}</div>
                    </div>
                </div>
            </aside>

            <main class="flex-1 flex flex-col overflow-hidden bg-white m-3 rounded shadow-sm border">
                <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                    <!-- å°ºå¯¸æ£€ç´¢æ¨¡å¼ -->
                    <div v-if="viewMode === 'search'" class="flex items-center gap-3 flex-wrap">
                        <span class="font-bold text-gray-600 text-base">æ£€ç´¢æ¨¡å¼:</span>
                        <select v-model="searchMode" class="search-mode-select">
                            <option value="size">æŒ‰å°ºå¯¸æ£€ç´¢</option>
                            <option value="name">æŒ‰åç§°æ£€ç´¢</option>
                            <option value="both">å°ºå¯¸+åç§°ç»„åˆæ£€ç´¢</option>
                        </select>
                        
                        <!-- å°ºå¯¸åŒ¹é…æ­£è´Ÿå·®å¼‚è°ƒèŠ‚ -->
                        <div v-if="searchMode === 'size' || searchMode === 'both'" class="flex items-center gap-2">
                            <span class="tolerance-label">å®¹å·®:</span>
                            <input 
                                type="number" 
                                v-model.number="tolerance" 
                                min="1" 
                                max="20"
                                class="tolerance-input"
                                title="å…è®¸çš„å°ºå¯¸å·®å¼‚èŒƒå›´ï¼ˆå•ä½ï¼šcmï¼‰"
                            >
                            <span class="text-sm text-gray-500">cm</span>
                        </div>
                        
                        <!-- å°ºå¯¸æ£€ç´¢éƒ¨åˆ† -->
                        <div v-if="searchMode === 'size' || searchMode === 'both'" class="flex items-center gap-3">
                            <span class="font-bold text-gray-600 text-base">ç›®æ ‡å°ºå¯¸:</span>
                            <input type="number" v-model.number="query.l" class="border p-2 w-18 rounded outline-none text-base" placeholder="é•¿">
                            <input type="number" v-model.number="query.w" class="border p-2 w-18 rounded outline-none text-base" placeholder="å®½">
                            <input type="number" v-model.number="query.h" class="border p-2 w-18 rounded outline-none text-base" placeholder="é«˜">
                        </div>
                        
                        <!-- åç§°æ£€ç´¢éƒ¨åˆ† -->
                        <div v-if="searchMode === 'name' || searchMode === 'both'" class="flex items-center gap-3">
                            <span class="font-bold text-gray-600 text-base">è´§å“åç§°:</span>
                            <input type="text" v-model="query.name" class="border p-2 w-52 rounded outline-none text-base" placeholder="è¾“å…¥è´§å“åç§°å…³é”®è¯">
                        </div>
                        
                        <button @click="doSearch" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition text-base">åŒ¹é…</button>
                        
                        <!-- æ˜¾ç¤ºå½“å‰åŒ¹é…æ¨¡å¼ -->
                        <div class="text-sm text-gray-500 ml-4">
                            <span v-if="searchMode === 'size'">å½“å‰: å°ºå¯¸åŒ¹é…(Â±{{tolerance}}cm)</span>
                            <span v-if="searchMode === 'name'">å½“å‰: åç§°æ¨¡ç³ŠåŒ¹é…</span>
                            <span v-if="searchMode === 'both'">å½“å‰: å°ºå¯¸+åç§°ç»„åˆåŒ¹é…</span>
                        </div>
                    </div>
                    
                    <!-- è´§å“æ¡£æ¡ˆæ¨¡å¼ -->
                    <div v-else-if="viewMode === 'all'" class="flex items-center gap-4 w-full justify-between">
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-gray-600 text-base">è´§å“æ¡£æ¡ˆ</span>
                            <span class="text-sm text-gray-400">å…± {{totalRecords}} æ¡è®°å½•</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- æ¯é¡µæ˜¾ç¤ºæ¡æ•°é€‰æ‹© -->
                            <div class="page-size-container">
                                <span class="page-size-label">æ¯é¡µ:</span>
                                <select v-model="archivePageSize" @change="resetArchiveToFirstPage" class="page-size-select">
                                    <option value="50">50æ¡</option>
                                    <option value="100">100æ¡</option>
                                    <option value="200">200æ¡</option>
                                    <option value="500">500æ¡</option>
                                    <option value="1000">1000æ¡</option>
                                </select>
                            </div>
                            <!-- åœ¨è´§å“æ¡£æ¡ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºå¯¼å…¥ç›¸å…³æŒ‰é’® -->
                            <button @click="downloadTemplate" class="bg-blue-800/40 hover:bg-blue-800/60 px-4 py-2 rounded text-sm transition border border-white/20">
                                ä¸‹è½½å¯¼å…¥æ¨¡æ¿
                            </button>
                            <button @click="triggerFileSelect" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-bold shadow-sm">
                                å¯¼å…¥ Excel è´§å“
                            </button>
                            <button v-if="boxDatabase.length > 0" 
                                    @click="clearDatabase" 
                                    class="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded border border-red-200">
                                æ¸…ç©ºæ‰€æœ‰è´§å“
                            </button>
                        </div>
                    </div>
                    
                    <!-- æœç´¢ç»Ÿè®¡æ¨¡å¼ -->
                    <div v-else class="flex items-center gap-4 w-full justify-between">
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-gray-600 text-base">æœç´¢ç»Ÿè®¡è®°å½•</span>
                            <span class="text-sm text-gray-400">å…± {{Object.keys(searchStats).length}} ç§å°ºå¯¸è¢«æœç´¢</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button @click="clearStats" class="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded border border-red-200">
                                æ¸…ç©ºç»Ÿè®¡
                            </button>
                            <button @click="exportStats" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm text-white font-bold shadow-sm">
                                å¯¼å‡ºç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ æ§ä»¶ - æ”¾åœ¨è¡¨æ ¼ä¸Šæ–¹ï¼Œä½†ä¸æ˜¾çœ¼ -->
                <input type="file" ref="fileInput" class="hidden" accept=".xlsx, .xls" @change="handleFileUpload">

                <div class="flex-1 overflow-auto bg-gray-50 relative" ref="scrollBox">
                    <!-- åŠ è½½æç¤º -->
                    <div v-if="isLoading" class="loading-overlay">
                        <div class="loading-spinner"></div>
                    </div>

                    <!-- å°ºå¯¸æ£€ç´¢å’Œè´§å“æ¡£æ¡ˆå…±ç”¨è¡¨æ ¼ -->
                    <table v-if="viewMode !== 'stats'" class="bg-white text-left border-collapse table-fixed min-w-full">
                        <thead class="sticky top-0 z-10">
                            <tr>
                                <th v-for="(col, idx) in columns" :key="idx" :style="{ width: col.width + 'px' }" class="p-3">
                                    {{ col.title }}
                                    <div class="resizer" @mousedown="startResize($event, idx)"></div>
                                </th>
                                <!-- åªåœ¨è´§å“æ¡£æ¡ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºæ“ä½œåˆ— -->
                                <th v-if="viewMode === 'all'" class="w-24 p-3 border text-base">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in currentDisplayData" :key="item.id || index" class="hover:bg-blue-50/50">
                                <td class="text-center text-gray-500 text-base">{{ getDisplayIndex(index) }}</td>
                                <td class="font-mono text-blue-600 px-3 text-base">{{ item.merchantCode || item.sku || '-' }}</td>
                                <td class="px-3 text-base">{{ item.name || '-' }}</td>
                                <!-- å°ºå¯¸ä¿¡æ¯åˆ— -->
                                <td class="text-center font-mono font-bold text-base">
                                    {{ item.l }}Ã—{{ item.w }}Ã—{{ item.h }}
                                </td>
                                <!-- å°ºå¯¸å·®å¼‚æ  -->
                                <td v-if="viewMode === 'search' && (searchMode === 'size' || searchMode === 'both') && query.l && query.w && query.h" 
                                    class="text-center px-3">
                                    <div class="flex flex-col items-center justify-center space-y-1">
                                        <div class="flex items-center">
                                            <span class="diff-label">é•¿:</span>
                                            <span :class="getDiffClass(item.diffL)">
                                                {{formatDiff(item.diffL)}}
                                            </span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="diff-label">å®½:</span>
                                            <span :class="getDiffClass(item.diffW)">
                                                {{formatDiff(item.diffW)}}
                                            </span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="diff-label">é«˜:</span>
                                            <span :class="getDiffClass(item.diffH)">
                                                {{formatDiff(item.diffH)}}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td v-else-if="viewMode === 'search'" class="text-center font-mono px-3 text-base">
                                    {{ item.l }}Ã—{{ item.w }}Ã—{{ item.h }}
                                </td>
                                <!-- åªåœ¨è´§å“æ¡£æ¡ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºæ“ä½œåˆ— -->
                                <td v-if="viewMode === 'all'" class="text-center">
                                    <button @click="deleteItem(item)" class="text-red-400 hover:text-red-600 text-sm">åˆ é™¤</button>
                                </td>
                            </tr>
                            <tr v-if="currentDisplayData.length === 0">
                                <td :colspan="emptyColspan" class="p-24 text-center text-gray-400 italic bg-white text-base">
                                    <template v-if="viewMode === 'search'">
                                        <span v-if="searchMode === 'size'">è¯·è¾“å…¥å°ºå¯¸è¿›è¡Œæ£€ç´¢...</span>
                                        <span v-else-if="searchMode === 'name'">è¯·è¾“å…¥è´§å“åç§°å…³é”®è¯è¿›è¡Œæ£€ç´¢...</span>
                                        <span v-else>è¯·è¾“å…¥å°ºå¯¸å’Œ/æˆ–è´§å“åç§°è¿›è¡Œæ£€ç´¢...</span>
                                    </template>
                                    <template v-else>
                                        æš‚æ— è´§å“æ•°æ®ï¼Œè¯·ä¸‹è½½æ¨¡æ¿å¡«å†™å¹¶å¯¼å…¥
                                    </template>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- æœç´¢ç»Ÿè®¡è¡¨æ ¼ -->
                    <table v-else class="bg-white text-left border-collapse table-fixed min-w-full">
                        <thead class="sticky top-0 z-10">
                            <tr>
                                <th class="p-3 border text-base" style="width: 60px;">åºå·</th>
                                <th class="p-3 border text-base" style="width: 140px;">å°ºå¯¸</th>
                                <th class="p-3 border text-base" style="width: 110px;">æœç´¢æ¬¡æ•°</th>
                                <th class="p-3 border text-base" style="width: 140px;">æœ€è¿‘æœç´¢æ—¶é—´</th>
                                <th class="p-3 border text-base" style="width: 140px;">é¦–æ¬¡æœç´¢æ—¶é—´</th>
                                <th class="p-3 border text-base" style="width: 90px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(stat, index) in sortedStats" :key="stat.key" class="hover:bg-purple-50/50">
                                <td class="text-center text-gray-500 text-base">{{ index + 1 }}</td>
                                <td class="text-center font-mono text-blue-600 font-bold px-3 text-base">
                                    {{ stat.l }}Ã—{{ stat.w }}Ã—{{ stat.h }}
                                </td>
                                <td class="text-center">
                                    <span class="stat-badge">{{ stat.count }}</span>
                                </td>
                                <td class="text-center text-gray-600 text-sm px-3">{{ stat.lastTime }}</td>
                                <td class="text-center text-gray-500 text-sm px-3">{{ stat.firstTime || stat.lastTime }}</td>
                                <td class="text-center">
                                    <button @click="applyStat(stat)" class="text-blue-400 hover:text-blue-600 text-sm px-3 py-2 rounded border border-blue-200">
                                        å¿«é€Ÿåº”ç”¨
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="sortedStats.length === 0">
                                <td colspan="6" class="p-24 text-center text-gray-400 italic bg-white text-base">
                                    æš‚æ— æœç´¢ç»Ÿè®¡è®°å½•
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µæ§ä»¶ - åœ¨è´§å“æ¡£æ¡ˆæ¨¡å¼ä¸‹æ˜¾ç¤º -->
                <div v-if="viewMode === 'all' && boxDatabase.length > 0" class="p-4 border-t bg-gray-50 flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        æ˜¾ç¤ºç¬¬ {{archiveStartIndex + 1}} åˆ° {{archiveEndIndex}} æ¡è®°å½•ï¼Œå…± {{totalRecords}} æ¡
                    </div>
                    <div class="pagination">
                        <button @click="goToFirstPage" :disabled="archiveCurrentPage === 1" class="page-btn">é¦–é¡µ</button>
                        <button @click="goToPrevPage" :disabled="archiveCurrentPage === 1" class="page-btn">ä¸Šä¸€é¡µ</button>
                        
                        <span class="page-info">
                            ç¬¬ 
                            <input 
                                type="number" 
                                v-model.number="archiveInputPage" 
                                @keyup.enter="goToArchiveInputPage"
                                :min="1" 
                                :max="archiveTotalPages" 
                                class="page-input current-page"
                            >
                            é¡µ / å…± {{archiveTotalPages}} é¡µ
                        </span>
                        
                        <button @click="goToNextPage" :disabled="archiveCurrentPage === archiveTotalPages" class="page-btn">ä¸‹ä¸€é¡µ</button>
                        <button @click="goToLastPage" :disabled="archiveCurrentPage === archiveTotalPages" class="page-btn">å°¾é¡µ</button>
                    </div>
                </div>

                <!-- åˆ†é¡µæ§ä»¶ - åœ¨å°ºå¯¸æ£€ç´¢æ¨¡å¼ä¸‹æ˜¾ç¤º -->
                <div v-if="viewMode === 'search' && searchResult.length > 0" class="p-4 border-t bg-gray-50 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-500">
                            æ˜¾ç¤ºç¬¬ {{searchStartIndex + 1}} åˆ° {{searchEndIndex}} æ¡è®°å½•ï¼Œå…± {{searchResult.length}} æ¡åŒ¹é…ç»“æœ
                        </div>
                        <!-- æ¯é¡µæ˜¾ç¤ºæ¡æ•°é€‰æ‹© - å°ºå¯¸æ£€ç´¢æ¨¡å¼ -->
                        <div class="page-size-container">
                            <span class="page-size-label">æ¯é¡µ:</span>
                            <select v-model="searchPageSize" @change="resetSearchToFirstPage" class="page-size-select">
                                <option value="20">20æ¡</option>
                                <option value="50">50æ¡</option>
                                <option value="100">100æ¡</option>
                                <option value="200">200æ¡</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination">
                        <button @click="goToSearchFirstPage" :disabled="searchCurrentPage === 1" class="page-btn">é¦–é¡µ</button>
                        <button @click="goToSearchPrevPage" :disabled="searchCurrentPage === 1" class="page-btn">ä¸Šä¸€é¡µ</button>
                        
                        <span class="page-info">
                            ç¬¬ 
                            <input 
                                type="number" 
                                v-model.number="searchInputPage" 
                                @keyup.enter="goToSearchInputPage"
                                :min="1" 
                                :max="searchTotalPages" 
                                class="page-input current-page"
                            >
                            é¡µ / å…± {{searchTotalPages}} é¡µ
                        </span>
                        
                        <button @click="goToSearchNextPage" :disabled="searchCurrentPage === searchTotalPages" class="page-btn">ä¸‹ä¸€é¡µ</button>
                        <button @click="goToSearchLastPage" :disabled="searchCurrentPage === searchTotalPages" class="page-btn">å°¾é¡µ</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const viewMode = ref('search');
                const searchMode = ref('size');
                const tolerance = ref(3);
                const query = ref({ l: null, w: null, h: null, name: '' });
                const boxDatabase = ref(JSON.parse(localStorage.getItem('box_db_v2') || '[]'));
                
                // è´§å“æ¡£æ¡ˆåˆ†é¡µç›¸å…³å˜é‡
                const archiveCurrentPage = ref(1);
                const archivePageSize = ref(100);
                const archiveInputPage = ref(1);
                
                // å°ºå¯¸æ£€ç´¢åˆ†é¡µç›¸å…³å˜é‡
                const searchCurrentPage = ref(1);
                const searchPageSize = ref(50);
                const searchInputPage = ref(1);
                const searchResult = ref([]); // å­˜å‚¨æœç´¢ç»“æœ
                
                const isLoading = ref(false);
                
                // å†å²è®°å½•ï¼ˆæŒ‰æ—¶é—´æ’åºï¼Œæ˜¾ç¤ºæœ€è¿‘æœç´¢ï¼‰
                const history = ref(JSON.parse(localStorage.getItem('box_history') || '[]'));
                
                // æœç´¢ç»Ÿè®¡ï¼ˆæŒ‰å°ºå¯¸ç»Ÿè®¡æœç´¢æ¬¡æ•°ï¼‰
                const searchStats = ref(JSON.parse(localStorage.getItem('box_search_stats') || '{}'));
                
                // è®°å½•ä¸Šä¸€æ¬¡æœç´¢çš„å°ºå¯¸ï¼ˆç”¨äºé¿å…é‡å¤è®°å½•ï¼‰
                const lastSearchSize = ref({ l: null, w: null, h: null });
                
                const fileInput = ref(null);

                // è§†å›¾åˆ‡æ¢æ—¶é‡ç½®åˆ†é¡µ
                const switchToSearch = () => {
                    viewMode.value = 'search';
                };
                
                const switchToAll = () => {
                    viewMode.value = 'all';
                    resetArchiveToFirstPage();
                };

                // è´§å“æ¡£æ¡ˆåˆ†é¡µè®¡ç®—
                const totalRecords = computed(() => boxDatabase.value.length);
                const archiveTotalPages = computed(() => Math.ceil(totalRecords.value / archivePageSize.value));
                const archiveStartIndex = computed(() => (archiveCurrentPage.value - 1) * archivePageSize.value);
                const archiveEndIndex = computed(() => {
                    const end = archiveCurrentPage.value * archivePageSize.value;
                    return end > totalRecords.value ? totalRecords.value : end;
                });
                
                // è´§å“æ¡£æ¡ˆåˆ†é¡µæ•°æ®
                const archivePaginatedData = computed(() => {
                    const start = archiveStartIndex.value;
                    const end = Math.min(start + archivePageSize.value, totalRecords.value);
                    return boxDatabase.value.slice(start, end);
                });

                // å°ºå¯¸æ£€ç´¢åˆ†é¡µè®¡ç®—
                const searchTotalPages = computed(() => Math.ceil(searchResult.value.length / searchPageSize.value));
                const searchStartIndex = computed(() => (searchCurrentPage.value - 1) * searchPageSize.value);
                const searchEndIndex = computed(() => {
                    const end = searchCurrentPage.value * searchPageSize.value;
                    return end > searchResult.value.length ? searchResult.value.length : end;
                });
                
                // å°ºå¯¸æ£€ç´¢åˆ†é¡µæ•°æ®
                const searchPaginatedData = computed(() => {
                    const start = searchStartIndex.value;
                    const end = Math.min(start + searchPageSize.value, searchResult.value.length);
                    return searchResult.value.slice(start, end);
                });

                // å½“å‰æ˜¾ç¤ºçš„æ•°æ®
                const currentDisplayData = computed(() => {
                    if (viewMode.value === 'all') {
                        return archivePaginatedData.value;
                    } else if (viewMode.value === 'search') {
                        return searchPaginatedData.value;
                    }
                    return [];
                });

                // è·å–æ˜¾ç¤ºåºå·ï¼ˆè€ƒè™‘åˆ†é¡µï¼‰
                const getDisplayIndex = (index) => {
                    if (viewMode.value === 'all') {
                        return archiveStartIndex.value + index + 1;
                    } else if (viewMode.value === 'search') {
                        return searchStartIndex.value + index + 1;
                    }
                    return index + 1;
                };

                // åŠ¨æ€åˆ—å®šä¹‰ - ç®€åŒ–åçš„åˆ—
                const columns = computed(() => {
                    const baseColumns = [
                        { title: 'åºå·', width: 60 },
                        { title: 'å•†å®¶ç¼–ç ', width: 140 },
                        { title: 'è´§å“åç§°', width: 220 },
                        { title: 'å°ºå¯¸ä¿¡æ¯', width: 140 }
                    ];
                    
                    // åœ¨å°ºå¯¸æ£€ç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºå°ºå¯¸å·®å¼‚ï¼Œåœ¨è´§å“æ¡£æ¡ˆæ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºé¢å¤–åˆ—
                    if (viewMode.value === 'search') {
                        return [...baseColumns, { title: 'å°ºå¯¸å·®å¼‚', width: 140 }];
                    } else {
                        return baseColumns;
                    }
                });

                // è®¡ç®—ç©ºæ•°æ®æç¤ºçš„colspan
                const emptyColspan = computed(() => {
                    if (viewMode.value === 'search') {
                        // å°ºå¯¸æ£€ç´¢æ¨¡å¼ï¼š4åˆ—åŸºç¡€åˆ— + (æ˜¾ç¤ºå°ºå¯¸å·®å¼‚ï¼Ÿ1:0)
                        return 4 + ((searchMode.value === 'size' || searchMode.value === 'both') && query.value.l && query.value.w && query.value.h ? 1 : 0);
                    } else if (viewMode.value === 'all') {
                        // è´§å“æ¡£æ¡ˆæ¨¡å¼ï¼š4åˆ—åŸºç¡€åˆ— + 1åˆ—æ“ä½œåˆ—
                        return 5;
                    }
                    return 4;
                });

                // æœç´¢æ•°æ®é€»è¾‘ - æ›´æ–°ä»¥æ”¯æŒå®¹å¿åº¦å’Œå¤šç§æœç´¢æ¨¡å¼
                const calculateSearchResult = () => {
                    const { l, w, h, name } = query.value;
                    
                    // å¦‚æœæ²¡æœ‰è¾“å…¥ä»»ä½•æ¡ä»¶ï¼Œè¿”å›ç©ºæ•°ç»„
                    if ((!l || !w || !h) && !name) return [];
                    
                    let result = boxDatabase.value;
                    
                    // æ ¹æ®æœç´¢æ¨¡å¼è¿›è¡Œç­›é€‰
                    if (searchMode.value === 'size' || searchMode.value === 'both') {
                        if (l && w && h) {
                            let target = [l, w, h].sort((a, b) => b - a);
                            result = result
                                .map(box => {
                                    let cur = [box.l, box.w, box.h].sort((a, b) => b - a);
                                    const diffL = cur[0] - target[0];
                                    const diffW = cur[1] - target[1];
                                    const diffH = cur[2] - target[2];
                                    const totalDiff = Math.abs(diffL) + Math.abs(diffW) + Math.abs(diffH);
                                    
                                    // ä½¿ç”¨å¯è°ƒèŠ‚çš„å®¹å¿åº¦
                                    if (Math.abs(diffL) <= tolerance.value && Math.abs(diffW) <= tolerance.value && Math.abs(diffH) <= tolerance.value) {
                                        return { 
                                            ...box, 
                                            diffL, 
                                            diffW, 
                                            diffH,
                                            totalDiff,
                                            // ä¿å­˜åŸå§‹é¡ºåºçš„å·®å¼‚
                                            origDiffL: box.l - l,
                                            origDiffW: box.w - w,
                                            origDiffH: box.h - h
                                        };
                                    }
                                    return null;
                                })
                                .filter(b => b !== null)
                                .sort((a, b) => a.totalDiff - b.totalDiff);
                        } else if (searchMode.value === 'size') {
                            // çº¯å°ºå¯¸æ¨¡å¼ä½†æ²¡æœ‰è¾“å…¥å®Œæ•´å°ºå¯¸ï¼Œè¿”å›ç©º
                            return [];
                        }
                    }
                    
                    // åç§°ç­›é€‰ï¼ˆé€‚ç”¨äºnameæ¨¡å¼å’Œbothæ¨¡å¼ï¼‰
                    if (searchMode.value === 'name' || searchMode.value === 'both') {
                        if (name && name.trim() !== '') {
                            const keyword = name.trim().toLowerCase();
                            result = result.filter(box => 
                                (box.name && box.name.toLowerCase().includes(keyword))
                            );
                        } else if (searchMode.value === 'name') {
                            // çº¯åç§°æ¨¡å¼ä½†æ²¡æœ‰è¾“å…¥åç§°ï¼Œè¿”å›ç©º
                            return [];
                        }
                    }
                    
                    return result;
                };

                // è®¡ç®—æ’åºåçš„ç»Ÿè®¡åˆ—è¡¨ï¼ˆæŒ‰æœç´¢æ¬¡æ•°é™åºï¼‰
                const sortedStats = computed(() => {
                    return Object.values(searchStats.value)
                        .sort((a, b) => b.count - a.count);
                });

                // æ ¼å¼åŒ–å·®å¼‚æ˜¾ç¤º
                const formatDiff = (diff) => {
                    if (diff === 0) return "0";
                    return diff > 0 ? `+${diff}` : `${diff}`;
                };
                
                // è·å–å·®å¼‚æ˜¾ç¤ºçš„CSSç±»
                const getDiffClass = (diff) => {
                    if (diff > 0) return "diff-positive";
                    if (diff < 0) return "diff-negative";
                    return "diff-zero";
                };

                // è´§å“æ¡£æ¡ˆåˆ†é¡µæ“ä½œæ–¹æ³•
                const resetArchiveToFirstPage = () => {
                    archiveCurrentPage.value = 1;
                    archiveInputPage.value = 1;
                };
                
                const goToFirstPage = () => {
                    archiveCurrentPage.value = 1;
                    archiveInputPage.value = 1;
                };
                
                const goToPrevPage = () => {
                    if (archiveCurrentPage.value > 1) {
                        archiveCurrentPage.value--;
                        archiveInputPage.value = archiveCurrentPage.value;
                    }
                };
                
                const goToNextPage = () => {
                    if (archiveCurrentPage.value < archiveTotalPages.value) {
                        archiveCurrentPage.value++;
                        archiveInputPage.value = archiveCurrentPage.value;
                    }
                };
                
                const goToLastPage = () => {
                    archiveCurrentPage.value = archiveTotalPages.value;
                    archiveInputPage.value = archiveCurrentPage.value;
                };
                
                const goToArchiveInputPage = () => {
                    let page = parseInt(archiveInputPage.value);
                    if (isNaN(page) || page < 1) {
                        page = 1;
                    } else if (page > archiveTotalPages.value) {
                        page = archiveTotalPages.value;
                    }
                    archiveCurrentPage.value = page;
                    archiveInputPage.value = page;
                };

                // å°ºå¯¸æ£€ç´¢åˆ†é¡µæ“ä½œæ–¹æ³•
                const resetSearchToFirstPage = () => {
                    searchCurrentPage.value = 1;
                    searchInputPage.value = 1;
                };
                
                const goToSearchFirstPage = () => {
                    searchCurrentPage.value = 1;
                    searchInputPage.value = 1;
                };
                
                const goToSearchPrevPage = () => {
                    if (searchCurrentPage.value > 1) {
                        searchCurrentPage.value--;
                        searchInputPage.value = searchCurrentPage.value;
                    }
                };
                
                const goToSearchNextPage = () => {
                    if (searchCurrentPage.value < searchTotalPages.value) {
                        searchCurrentPage.value++;
                        searchInputPage.value = searchCurrentPage.value;
                    }
                };
                
                const goToSearchLastPage = () => {
                    searchCurrentPage.value = searchTotalPages.value;
                    searchInputPage.value = searchCurrentPage.value;
                };
                
                const goToSearchInputPage = () => {
                    let page = parseInt(searchInputPage.value);
                    if (isNaN(page) || page < 1) {
                        page = 1;
                    } else if (page > searchTotalPages.value) {
                        page = searchTotalPages.value;
                    }
                    searchCurrentPage.value = page;
                    searchInputPage.value = page;
                };

                // ç›‘å¬å½“å‰é¡µç å˜åŒ–ï¼ŒåŒæ­¥è¾“å…¥æ¡†
                watch(archiveCurrentPage, (newVal) => {
                    archiveInputPage.value = newVal;
                });
                
                watch(searchCurrentPage, (newVal) => {
                    searchInputPage.value = newVal;
                });

                // ä¸‹è½½ Excel æ¨¡æ¿
                const downloadTemplate = () => {
                    const data = [ 
                        ["å•†å®¶ç¼–ç ", "è´§å“åç§°", "é•¿", "å®½", "é«˜"], 
                        ["MC001", "A4æ ‡å‡†çº¸ç®±", 30, 20, 15] 
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "è´§å“å¯¼å…¥æ¨¡æ¿");
                    XLSX.writeFile(wb, "çº¸ç®±å¯¼å…¥æ¨¡æ¿.xlsx");
                };

                // å¯¼å…¥åŠŸèƒ½ - ç®€åŒ–åçš„å¯¼å…¥é€»è¾‘
                const triggerFileSelect = () => fileInput.value.click();
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // æ˜¾ç¤ºåŠ è½½æç¤º
                    isLoading.value = true;
                    
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                            
                            const newItems = json.map(r => ({
                                id: Date.now() + Math.random(),
                                merchantCode: r['å•†å®¶ç¼–ç '] || r['ç¼–å·'] || 'N/A', // å…¼å®¹æ—§æ¨¡æ¿
                                name: r['è´§å“åç§°'] || r['åç§°'] || 'æœªå‘½å',
                                l: Number(r['é•¿']) || 0, 
                                w: Number(r['å®½']) || 0, 
                                h: Number(r['é«˜']) || 0,
                                // ä¿ç•™æ—§çš„skuå­—æ®µç”¨äºå…¼å®¹
                                sku: r['å•†å®¶ç¼–ç '] || r['ç¼–å·'] || 'N/A'
                            }));
                            
                            boxDatabase.value = [...boxDatabase.value, ...newItems];
                            saveDb();
                            alert(`æˆåŠŸå¯¼å…¥ ${newItems.length} ä¸ªè´§å“`);
                            viewMode.value = 'all';
                            resetArchiveToFirstPage();
                        } catch (error) {
                            alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                        } finally {
                            isLoading.value = false;
                        }
                    };
                    
                    reader.onerror = () => {
                        alert('æ–‡ä»¶è¯»å–å¤±è´¥');
                        isLoading.value = false;
                    };
                    
                    reader.readAsArrayBuffer(file);
                };

                // åˆ é™¤è´§å“
                const deleteItem = (item) => {
                    if(confirm(`ç¡®è®¤åˆ é™¤è´§å“ï¼š${item.name}ï¼Ÿ`)) {
                        boxDatabase.value = boxDatabase.value.filter(b => b.id !== item.id);
                        saveDb();
                        // å¦‚æœåˆ é™¤åå½“å‰é¡µæ²¡æœ‰æ•°æ®äº†ï¼Œè¿”å›ä¸Šä¸€é¡µ
                        if (archivePaginatedData.value.length === 0 && archiveCurrentPage.value > 1) {
                            archiveCurrentPage.value--;
                        }
                    }
                };

                const clearDatabase = () => {
                    if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰è´§å“æ¡£æ¡ˆå—ï¼Ÿè¯¥æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                        boxDatabase.value = [];
                        saveDb();
                        resetArchiveToFirstPage();
                    }
                };

                const saveDb = () => {
                    try {
                        localStorage.setItem('box_db_v2', JSON.stringify(boxDatabase.value));
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜æ‰€æœ‰æ•°æ®ã€‚è¯·åˆ é™¤éƒ¨åˆ†æ•°æ®æˆ–æ¸…ç†æµè§ˆå™¨ç¼“å­˜ã€‚');
                        } else {
                            alert('ä¿å­˜æ•°æ®å¤±è´¥ï¼š' + e.message);
                        }
                    }
                };
                
                const saveStats = () => localStorage.setItem('box_search_stats', JSON.stringify(searchStats.value));

                // æ£€æŸ¥æ˜¯å¦ä¸ºç›¸åŒå°ºå¯¸æœç´¢
                const isSameSizeSearch = (l, w, h) => {
                    return lastSearchSize.value.l === l && 
                           lastSearchSize.value.w === w && 
                           lastSearchSize.value.h === h;
                };

                // æ£€ç´¢ä¸å†å²
                const doSearch = () => {
                    const { l, w, h, name } = query.value;
                    
                    // è®¡ç®—æœç´¢ç»“æœ
                    const result = calculateSearchResult();
                    searchResult.value = result;
                    
                    // é‡ç½®æœç´¢åˆ†é¡µåˆ°ç¬¬ä¸€é¡µ
                    resetSearchToFirstPage();
                    
                    // æ ¹æ®æœç´¢æ¨¡å¼å†³å®šæ˜¯å¦è®°å½•ç»Ÿè®¡
                    if ((searchMode.value === 'size' || searchMode.value === 'both') && l && w && h) {
                        const time = new Date().toLocaleTimeString();
                        const dateTime = new Date().toLocaleString();
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºç›¸åŒå°ºå¯¸æœç´¢
                        const sameSize = isSameSizeSearch(l, w, h);
                        
                        // å¦‚æœä¸æ˜¯ç›¸åŒå°ºå¯¸æœç´¢ï¼Œåˆ™è®°å½•ç»Ÿè®¡
                        if (!sameSize) {
                            // æ›´æ–°ä¸Šä¸€æ¬¡æœç´¢å°ºå¯¸
                            lastSearchSize.value = { l, w, h };
                            
                            // 1. æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
                            // æ£€æŸ¥å†å²è®°å½•ä¸­æ˜¯å¦å·²ç»æœ‰å®Œå…¨ç›¸åŒçš„å°ºå¯¸
                            const existingHistoryIndex = history.value.findIndex(h => 
                                h.l === l && h.w === w && h.h === h
                            );
                            
                            if (existingHistoryIndex !== -1) {
                                // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°æ—¶é—´å’Œæ¬¡æ•°
                                history.value[existingHistoryIndex].time = time;
                                history.value[existingHistoryIndex].count = (history.value[existingHistoryIndex].count || 1) + 1;
                                // ç§»åŠ¨åˆ°æœ€å‰é¢
                                const existingItem = history.value.splice(existingHistoryIndex, 1)[0];
                                history.value.unshift(existingItem);
                            } else {
                                // æ·»åŠ æ–°è®°å½•
                                history.value.unshift({ l, w, h, time, count: 1 });
                                if (history.value.length > 15) history.value.pop();
                            }
                            localStorage.setItem('box_history', JSON.stringify(history.value));
                            
                            // 2. æ›´æ–°æœç´¢ç»Ÿè®¡
                            const key = `${l}-${w}-${h}`;
                            if (searchStats.value[key]) {
                                // å·²å­˜åœ¨ï¼Œæ›´æ–°æ¬¡æ•°å’Œæ—¶é—´
                                searchStats.value[key].count += 1;
                                searchStats.value[key].lastTime = dateTime;
                            } else {
                                // æ–°å°ºå¯¸ï¼Œæ·»åŠ è®°å½•
                                searchStats.value[key] = {
                                    key,
                                    l, w, h,
                                    count: 1,
                                    firstTime: dateTime,
                                    lastTime: dateTime
                                };
                            }
                            saveStats();
                        }
                    } else {
                        // å¦‚æœæ˜¯çº¯åç§°æœç´¢ï¼Œé‡ç½®ä¸Šä¸€æ¬¡æœç´¢å°ºå¯¸
                        lastSearchSize.value = { l: null, w: null, h: null };
                    }
                };
                
                // ä»å†å²è®°å½•åº”ç”¨
                const applyHistory = (h) => { 
                    // é‡ç½®ä¸Šä¸€æ¬¡æœç´¢å°ºå¯¸ï¼Œè¿™æ ·ç‚¹å‡»å†å²è®°å½•æ—¶ä¼šè®°å½•æ–°çš„æœç´¢
                    lastSearchSize.value = { l: null, w: null, h: null };
                    
                    query.value = { l: h.l, w: h.w, h: h.h, name: '' }; 
                    viewMode.value = 'search';
                    searchMode.value = 'size';
                    
                    // è‡ªåŠ¨æ‰§è¡Œæœç´¢
                    doSearch();
                };
                
                // ä»ç»Ÿè®¡è®°å½•åº”ç”¨
                const applyStat = (stat) => {
                    // é‡ç½®ä¸Šä¸€æ¬¡æœç´¢å°ºå¯¸ï¼Œè¿™æ ·ç‚¹å‡»ç»Ÿè®¡è®°å½•æ—¶ä¼šè®°å½•æ–°çš„æœç´¢
                    lastSearchSize.value = { l: null, w: null, h: null };
                    
                    query.value = { l: stat.l, w: stat.w, h: stat.h, name: '' };
                    viewMode.value = 'search';
                    searchMode.value = 'size';
                    
                    // è‡ªåŠ¨æ‰§è¡Œæœç´¢
                    doSearch();
                };
                
                const clearHistory = () => { 
                    history.value = []; 
                    localStorage.removeItem('box_history'); 
                };
                
                // æ¸…ç©ºæœç´¢ç»Ÿè®¡
                const clearStats = () => {
                    if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æœç´¢ç»Ÿè®¡è®°å½•å—ï¼Ÿè¯¥æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                        searchStats.value = {};
                        saveStats();
                    }
                };
                
                // å¯¼å‡ºæœç´¢ç»Ÿè®¡
                const exportStats = () => {
                    const statsArray = Object.values(searchStats.value).map(stat => ({
                        å°ºå¯¸: `${stat.l}Ã—${stat.w}Ã—${stat.h}`,
                        æœç´¢æ¬¡æ•°: stat.count,
                        é¦–æ¬¡æœç´¢æ—¶é—´: stat.firstTime,
                        æœ€è¿‘æœç´¢æ—¶é—´: stat.lastTime
                    }));
                    
                    if (statsArray.length === 0) {
                        alert('æš‚æ— ç»Ÿè®¡æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    
                    const ws = XLSX.utils.json_to_sheet(statsArray);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "æœç´¢ç»Ÿè®¡");
                    XLSX.writeFile(wb, "çº¸ç®±æœç´¢ç»Ÿè®¡.xlsx");
                };

                // åˆ—å®½è°ƒèŠ‚
                let startX, startW, curCol;
                const startResize = (e, i) => { 
                    startX = e.pageX; 
                    startW = columns.value[i].width; 
                    curCol = i; 
                    document.addEventListener('mousemove', onMove); 
                    document.addEventListener('mouseup', onUp);
                };
                const onMove = (e) => { 
                    if(curCol !== undefined) columns.value[curCol].width = Math.max(40, startW + (e.pageX - startX)); 
                };
                const onUp = () => { curCol = undefined; };

                return { 
                    viewMode, searchMode, tolerance, query, boxDatabase, history, searchStats, sortedStats,
                    archiveCurrentPage, archivePageSize, archiveInputPage, archiveTotalPages, archiveStartIndex, archiveEndIndex,
                    searchCurrentPage, searchPageSize, searchInputPage, searchTotalPages, searchStartIndex, searchEndIndex, searchResult,
                    isLoading, totalRecords,
                    columns, emptyColspan, currentDisplayData, fileInput, 
                    switchToSearch, switchToAll,
                    downloadTemplate, triggerFileSelect, handleFileUpload, 
                    deleteItem, clearDatabase, 
                    doSearch, applyHistory, applyStat, clearHistory, clearStats, exportStats,
                    formatDiff, getDiffClass, getDisplayIndex,
                    resetArchiveToFirstPage, goToFirstPage, goToPrevPage, goToNextPage, goToLastPage, goToArchiveInputPage,
                    resetSearchToFirstPage, goToSearchFirstPage, goToSearchPrevPage, goToSearchNextPage, goToSearchLastPage, goToSearchInputPage,
                    startResize 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>